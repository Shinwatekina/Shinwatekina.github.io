<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MO2 Database Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        :root {
            --bg-deep: #0a0012; --bg-dark: #0E0E10; --bg-card: #12081a; --bg-card-hover: #1a0d24;
            --purple-dark: #1a0024; --purple-mid: #240042; --purple-glow: #8b5cf6; --purple-bright: #a78bfa;
            --magenta: #d946ef; --neon-green: #8BFFA7; --cyan: #22d3ee; --orange: #f97316; --red: #ef4444;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-dim: #64748b;
            --border-color: rgba(139, 92, 246, 0.3); --border-glow: rgba(139, 92, 246, 0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; }
        body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(139, 92, 246, 0.03) 1px, transparent 1px); background-size: 50px 50px; pointer-events: none; z-index: -1; }
        body::after { content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse at top, rgba(139, 92, 246, 0.1) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(217, 70, 239, 0.08) 0%, transparent 40%); pointer-events: none; z-index: -1; }
        
        .header { background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%); border-bottom: 1px solid var(--border-color); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(20px); }
        .header-content { max-width: 1800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--purple-glow), var(--magenta)); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 25px rgba(139, 92, 246, 0.4); }
        .logo-icon svg { width: 24px; height: 24px; fill: white; }
        .logo-text { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; letter-spacing: 2px; background: linear-gradient(90deg, var(--text-primary), var(--purple-bright)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo-sub { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--neon-green); letter-spacing: 2px; }
        
        .search-container { flex: 1; max-width: 450px; position: relative; }
        .search-input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--purple-glow); box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .search-input::placeholder { color: var(--text-dim); }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; width: 18px; height: 18px; }
        
        .header-controls { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.75rem; background: rgba(139, 255, 167, 0.1); border: 1px solid rgba(139, 255, 167, 0.3); border-radius: 16px; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: var(--neon-green); letter-spacing: 1px; }
        .status-badge.error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--red); }
        .status-badge.dev { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3); color: var(--orange); }
        .status-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .ctrl-btn { padding: 0.4rem 0.75rem; background: rgba(139, 92, 246, 0.1); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.3rem; }
        .ctrl-btn:hover { background: rgba(139, 92, 246, 0.2); border-color: var(--purple-glow); color: var(--text-primary); }
        .ctrl-btn.active { background: var(--purple-glow); color: white; border-color: var(--purple-glow); }
        .ctrl-btn.dev { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3); color: var(--orange); }
        .ctrl-btn.dev:hover { background: rgba(249, 115, 22, 0.2); }
        .ctrl-btn.dev.active { background: var(--orange); color: var(--bg-dark); }
        
        .main-container { max-width: 1800px; margin: 0 auto; padding: 1.5rem; display: grid; grid-template-columns: 240px 1fr; gap: 1.5rem; }
        .sidebar { position: sticky; top: 80px; height: fit-content; max-height: calc(100vh - 100px); overflow-y: auto; }
        .sidebar-title { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 0.75rem; padding-left: 0.75rem; }
        .nav-list { list-style: none; display: flex; flex-direction: column; gap: 0.2rem; }
        .nav-btn { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.75rem; background: transparent; border: 1px solid transparent; border-radius: 8px; color: var(--text-secondary); font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: left; position: relative; }
        .nav-btn:hover { background: var(--bg-card); border-color: var(--border-color); color: var(--text-primary); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(217, 70, 239, 0.1)); border-color: var(--purple-glow); color: var(--text-primary); }
        .nav-btn.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 50%; background: linear-gradient(180deg, var(--purple-glow), var(--magenta)); border-radius: 2px; }
        .nav-icon { font-size: 1rem; margin-right: 0.5rem; }
        .nav-count { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; padding: 0.15rem 0.4rem; background: rgba(139, 92, 246, 0.2); border-radius: 4px; color: var(--purple-bright); }
        
        .content { min-height: 400px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 0.5rem; }
        .content-title { font-family: 'Orbitron', sans-serif; font-size: 1.25rem; font-weight: 600; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
        .content-title-icon { font-size: 1.4rem; }
        .content-stats { display: flex; gap: 1rem; align-items: center; }
        .results-count { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--text-dim); }
        .results-count span { color: var(--neon-green); }
        .class-filter { padding: 0.4rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; }
        
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.75rem; }
        .item-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.25s ease; position: relative; overflow: hidden; }
        .item-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--purple-glow), transparent); opacity: 0; transition: opacity 0.3s ease; }
        .item-card:hover { background: var(--bg-card-hover); border-color: var(--border-glow); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(139, 92, 246, 0.15); }
        .item-card:hover::before { opacity: 1; }
        .item-card.favorite { border-color: var(--orange); }
        .item-card.favorite::after { content: '‚≠ê'; position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.8rem; }
        
        .item-header { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
        .item-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--purple-dark), var(--purple-mid)); border: 1px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0; position: relative; overflow: hidden; }
        .item-icon img { width: 100%; height: 100%; object-fit: contain; border-radius: 7px; image-rendering: pixelated; }
        .edit-icon-btn { position: absolute; top: -3px; right: -3px; width: 18px; height: 18px; background: var(--orange); border: none; border-radius: 50%; color: white; font-size: 9px; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 5; }
        .dev-mode .edit-icon-btn { display: flex; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-class { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--cyan); background: rgba(34, 211, 238, 0.1); padding: 0.15rem 0.4rem; border-radius: 3px; display: inline-block; }
        .item-internal { font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: var(--text-dim); margin-top: 0.15rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-props { display: flex; flex-wrap: wrap; gap: 0.35rem; }
        .item-prop { font-size: 0.7rem; padding: 0.2rem 0.4rem; background: rgba(139, 92, 246, 0.1); border-radius: 3px; color: var(--text-secondary); }
        .item-prop-key { color: var(--purple-bright); }
        .item-prop-val { color: var(--text-primary); }
        
        /* Modal styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border-glow); border-radius: 12px; width: 100%; max-width: 750px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(139, 92, 246, 0.3); animation: modalIn 0.25s ease; }
        .modal.wide { max-width: 950px; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        .modal-header { padding: 1rem 1.25rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(217, 70, 239, 0.1)); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.75rem; }
        .modal-icon { width: 56px; height: 56px; background: linear-gradient(135deg, var(--purple-dark), var(--purple-mid)); border: 1px solid var(--border-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; flex-shrink: 0; overflow: hidden; }
        .modal-icon img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .modal-title-section { flex: 1; min-width: 0; }
        .modal-title { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.2rem; word-break: break-word; }
        .modal-class { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--cyan); background: rgba(34, 211, 238, 0.15); padding: 0.2rem 0.5rem; border-radius: 4px; }
        .modal-actions { display: flex; gap: 0.5rem; }
        .modal-action-btn { width: 32px; height: 32px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.2s ease; }
        .modal-action-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); border-color: var(--border-glow); }
        .modal-action-btn.fav.active { color: var(--orange); border-color: var(--orange); }
        
        .modal-body { padding: 1rem 1.25rem; max-height: calc(85vh - 90px); overflow-y: auto; }
        
        .section { margin-bottom: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.75rem; background: rgba(139, 92, 246, 0.1); cursor: pointer; transition: all 0.2s ease; user-select: none; }
        .section-header:hover { background: rgba(139, 92, 246, 0.15); }
        .section-title { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; font-weight: 600; letter-spacing: 1px; color: var(--purple-bright); display: flex; align-items: center; gap: 0.4rem; }
        .section-icon { font-size: 0.9rem; }
        .section-meta { display: flex; align-items: center; gap: 0.5rem; }
        .section-count { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--text-dim); background: rgba(0,0,0,0.2); padding: 0.15rem 0.4rem; border-radius: 3px; }
        .section-toggle { font-size: 0.8rem; color: var(--text-dim); transition: transform 0.2s ease; }
        .section.collapsed .section-toggle { transform: rotate(-90deg); }
        .section-content { padding: 0.75rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
        .section.collapsed .section-content { display: none; }
        
        .prop { background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.12); border-radius: 6px; padding: 0.5rem 0.6rem; }
        .prop-key { font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: var(--text-dim); margin-bottom: 0.15rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .prop-value { font-size: 0.8rem; color: var(--text-primary); word-break: break-word; }
        .prop-value.bool { color: var(--neon-green); }
        .prop-value.bool.false { color: var(--red); }
        .prop-value.number { color: var(--cyan); }
        .prop-value.range { color: var(--orange); }
        .prop-value.ref { color: #f0abfc; cursor: pointer; }
        .prop-value.ref:hover { text-decoration: underline; }
        
        .loot-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .loot-table th, .loot-table td { padding: 0.5rem 0.6rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .loot-table th { font-family: 'Orbitron', sans-serif; font-size: 0.65rem; letter-spacing: 0.5px; color: var(--purple-bright); background: rgba(139, 92, 246, 0.08); }
        .loot-table td { font-family: 'Share Tech Mono', monospace; }
        .loot-link { color: var(--text-primary); cursor: pointer; }
        .loot-link:hover { color: var(--cyan); text-decoration: underline; }
        .loot-chance { color: var(--neon-green); }
        .loot-qty { color: var(--cyan); }
        
        /* Config Modal */
        .config-tabs { display: flex; gap: 0.4rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.4rem; flex-wrap: wrap; }
        .config-tab { padding: 0.4rem 0.75rem; background: transparent; border: 1px solid var(--border-color); border-radius: 6px 6px 0 0; color: var(--text-secondary); font-family: 'Orbitron', sans-serif; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; }
        .config-tab:hover { background: rgba(139, 92, 246, 0.1); }
        .config-tab.active { background: var(--purple-glow); color: white; border-color: var(--purple-glow); }
        .config-panel { display: none; }
        .config-panel.active { display: block; }
        .config-section { margin-bottom: 1rem; }
        .config-title { font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: var(--purple-bright); margin-bottom: 0.5rem; letter-spacing: 0.5px; }
        .config-desc { color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.75rem; }
        .config-select { width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; margin-bottom: 0.5rem; }
        
        .field-list { max-height: 280px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; }
        .field-group-header { padding: 0.4rem 0.6rem; background: rgba(139, 92, 246, 0.15); font-family: 'Orbitron', sans-serif; font-size: 0.65rem; color: var(--purple-bright); letter-spacing: 0.5px; position: sticky; top: 0; }
        .field-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; border-bottom: 1px solid rgba(139, 92, 246, 0.1); }
        .field-item:hover { background: rgba(139, 92, 246, 0.05); }
        .field-item input { width: 16px; height: 16px; accent-color: var(--purple-glow); cursor: pointer; }
        .field-item label { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); cursor: pointer; flex: 1; }
        .field-item.hidden label { color: var(--text-dim); text-decoration: line-through; }
        .field-item .override-badge { font-size: 0.6rem; padding: 0.1rem 0.3rem; background: var(--orange); color: white; border-radius: 3px; }
        
        .override-list { max-height: 350px; overflow-y: auto; }
        .override-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem; background: rgba(0,0,0,0.15); border-radius: 6px; margin-bottom: 0.4rem; }
        .override-item img { width: 36px; height: 36px; object-fit: contain; image-rendering: pixelated; }
        .override-info { flex: 1; min-width: 0; }
        .override-name { font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .override-path { font-size: 0.65rem; color: var(--text-dim); }
        .override-remove { background: none; border: none; color: var(--red); cursor: pointer; font-size: 1rem; padding: 0.2rem; }
        
        .config-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        .btn { padding: 0.5rem 0.75rem; border-radius: 6px; font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .btn-primary { background: var(--neon-green); color: var(--bg-dark); }
        .btn-primary:hover { background: #6ee7a0; }
        .btn-secondary { background: rgba(139, 92, 246, 0.2); border-color: var(--purple-glow); color: var(--purple-bright); }
        .btn-secondary:hover { background: rgba(139, 92, 246, 0.3); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border-color: var(--red); color: var(--red); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.3); }
        .btn-ghost { background: transparent; border-color: var(--border-color); color: var(--text-secondary); }
        .btn-ghost:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        
        /* Login */
        .login-modal { background: var(--bg-card); border: 1px solid var(--orange); border-radius: 12px; padding: 1.5rem; width: 100%; max-width: 320px; }
        .login-title { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--orange); margin-bottom: 1rem; text-align: center; }
        .login-input { width: 100%; padding: 0.6rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'Share Tech Mono', monospace; margin-bottom: 0.75rem; }
        .login-input:focus { outline: none; border-color: var(--orange); }
        .login-btn { width: 100%; padding: 0.6rem; background: var(--orange); border: none; border-radius: 6px; color: white; font-family: 'Orbitron', sans-serif; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: #ea580c; }
        
        /* Icon Picker */
        .icon-preview { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 6px; margin-bottom: 0.75rem; }
        .icon-preview img { width: 48px; height: 48px; object-fit: contain; image-rendering: pixelated; background: var(--bg-dark); border-radius: 6px; padding: 0.25rem; }
        .icon-preview-info { flex: 1; }
        .icon-preview-name { font-family: 'Orbitron', sans-serif; font-size: 0.85rem; }
        .icon-preview-path { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: var(--text-dim); }
        .icon-controls { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .icon-search { flex: 1; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; }
        .icon-folder { padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; min-width: 120px; }
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.4rem; max-height: 320px; overflow-y: auto; padding: 0.25rem; }
        .icon-opt { aspect-ratio: 1; background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 0.35rem; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; }
        .icon-opt:hover { border-color: var(--purple-glow); transform: scale(1.05); }
        .icon-opt.selected { border-color: var(--neon-green); box-shadow: 0 0 8px rgba(139, 255, 167, 0.3); }
        .icon-opt img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        
        /* Utility */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; gap: 1rem; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--purple-glow); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; color: var(--text-dim); letter-spacing: 1px; }
        
        .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; gap: 0.75rem; }
        .empty-icon { font-size: 2.5rem; opacity: 0.4; }
        .empty-text { font-family: 'Share Tech Mono', monospace; color: var(--text-dim); text-align: center; font-size: 0.85rem; }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 0.35rem; margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        .page-btn { padding: 0.4rem 0.7rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; cursor: pointer; transition: all 0.15s ease; }
        .page-btn:hover:not(:disabled) { background: var(--bg-card-hover); border-color: var(--border-glow); color: var(--text-primary); }
        .page-btn.active { background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(217, 70, 239, 0.2)); border-color: var(--purple-glow); color: var(--text-primary); }
        .page-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .page-info { font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: var(--text-dim); padding: 0 0.25rem; }
        
        .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.75rem 1rem; background: var(--bg-card); border: 1px solid var(--neon-green); border-radius: 6px; color: var(--neon-green); font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; z-index: 2000; animation: toastIn 0.25s ease, toastOut 0.25s ease 2.5s forwards; }
        .toast.error { border-color: var(--red); color: var(--red); }
        .toast.warning { border-color: var(--orange); color: var(--orange); }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--purple-dark); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--purple-mid); }
        
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .sidebar { position: static; max-height: none; } .nav-list { flex-direction: row; flex-wrap: wrap; gap: 0.3rem; } .nav-btn { padding: 0.4rem 0.6rem; font-size: 0.8rem; } }
        @media (max-width: 600px) { .header-content { flex-direction: column; align-items: stretch; } .search-container { max-width: none; } .items-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
                <div><div class="logo-text">MO2 DATABASE</div><div class="logo-sub">Content Browser v3.2</div></div>
            </div>
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Search entries... (Ctrl+K)">
            </div>
            <div class="header-controls">
                <div class="status-badge" id="statusBadge"><div class="status-dot"></div><span id="statusText">LOADING</span></div>
                <button class="ctrl-btn dev" id="devBtn">üîß DEV</button>
                <button class="ctrl-btn" id="configBtn" style="display:none">‚öôÔ∏è</button>
                <button class="ctrl-btn" id="favBtn" title="Show favorites only">‚≠ê</button>
            </div>
        </div>
    </header>
    
    <main class="main-container">
        <aside class="sidebar"><div class="sidebar-title">CATEGORIES</div><ul class="nav-list" id="navList"></ul></aside>
        <section class="content"><div id="contentArea"><div class="loading"><div class="spinner"></div><div class="loading-text">LOADING DATABASE...</div></div></div></section>
    </main>

    <!-- Item Detail Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon"></div>
                <div class="modal-title-section"><h2 class="modal-title" id="modalTitle">Item</h2><span class="modal-class" id="modalClass">class</span></div>
                <div class="modal-actions">
                    <button class="modal-action-btn fav" id="modalFav" title="Toggle favorite">‚≠ê</button>
                    <button class="modal-action-btn" id="modalCopy" title="Copy JSON">üìã</button>
                    <button class="modal-action-btn" id="modalClose">‚úï</button>
                </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginOverlay">
        <div class="login-modal">
            <h2 class="login-title">üîê Developer Access</h2>
            <input type="password" class="login-input" id="loginPassword" placeholder="Password...">
            <button class="login-btn" id="loginBtn">LOGIN</button>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div class="modal-overlay" id="iconPickerOverlay">
        <div class="modal wide">
            <div class="modal-header">
                <div class="modal-title-section"><h2 class="modal-title">Select Icon</h2><span class="modal-class" id="iconPickerItem">item</span></div>
                <div class="modal-actions"><button class="modal-action-btn" id="iconPickerClose">‚úï</button></div>
            </div>
            <div class="modal-body">
                <div class="icon-preview"><img id="curIconImg" src=""><div class="icon-preview-info"><div class="icon-preview-name">Current Icon</div><div class="icon-preview-path" id="curIconPath">-</div></div></div>
                <div class="icon-controls"><input type="text" class="icon-search" id="iconSearch" placeholder="Search..."><select class="icon-folder" id="iconFolder"><option value="">All</option></select></div>
                <div class="icon-grid" id="iconGrid"></div>
                <div class="config-actions"><button class="btn btn-ghost" id="iconCancel">Cancel</button><button class="btn btn-primary" id="iconSave">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal-overlay" id="configOverlay">
        <div class="modal wide">
            <div class="modal-header">
                <div class="modal-title-section"><h2 class="modal-title">‚öôÔ∏è Configuration</h2><span class="modal-class">Manage icons & field visibility</span></div>
                <div class="modal-actions"><button class="modal-action-btn" id="configClose">‚úï</button></div>
            </div>
            <div class="modal-body">
                <div class="config-tabs">
                    <button class="config-tab active" data-tab="icons">Icons</button>
                    <button class="config-tab" data-tab="fields">Fields</button>
                    <button class="config-tab" data-tab="info">Info</button>
                </div>
                <div class="config-panel active" id="panel-icons">
                    <div class="config-section">
                        <div class="config-title">Icon Overrides</div>
                        <div class="config-desc">Changes are saved to server. Click ‚úèÔ∏è on cards to change icons.</div>
                        <div class="override-list" id="iconOverridesList"></div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-secondary" id="exportIconsBtn">üì• Export</button>
                        <button class="btn btn-danger" id="clearIconsBtn">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                <div class="config-panel" id="panel-fields">
                    <div class="config-section">
                        <div class="config-title">Field Visibility</div>
                        <div class="config-desc">Hide fields globally or per-class. Table-level settings apply to all classes unless overridden.</div>
                        <select class="config-select" id="fieldTable"><option value="">Select table...</option></select>
                        <select class="config-select" id="fieldClass"><option value="_all">All Classes (Global)</option></select>
                        <div class="field-list" id="fieldsList"></div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-primary" id="saveFieldsBtn">üíæ Save</button>
                        <button class="btn btn-secondary" id="exportFieldsBtn">üì• Export</button>
                    </div>
                </div>
                <div class="config-panel" id="panel-info">
                    <div class="config-section">
                        <div class="config-title">Database Info</div>
                        <div id="dbInfo" style="font-family: Share Tech Mono, monospace; font-size: 0.8rem; color: var(--text-secondary);"></div>
                    </div>
                    <div class="config-actions">
                        <button class="btn btn-secondary" id="exportAllBtn">üì• Export Full Config</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const CAT_ICONS = { items:'üì¶', enemies:'üëπ', npcs:'üßë', skills:'‚ö°', structures:'üèõÔ∏è', spawners:'üéØ', misc:'üîß', AIattacks:'‚öîÔ∏è', spells:'‚ú®', GemEffects:'üíé', Decorations:'üé®', buffs:'üõ°Ô∏è', drops:'üí∞', projectiles:'üèπ', ModularBuilding:'üèóÔ∏è', Stats:'üìä' };
const CAT_NAMES = { items:'Items', enemies:'Enemies', npcs:'NPCs', skills:'Skills', structures:'Structures', spawners:'Spawners', misc:'Materials', AIattacks:'AI Attacks', spells:'Spells', GemEffects:'Gem Effects', Decorations:'Decorations', buffs:'Buffs', drops:'Drops', projectiles:'Projectiles', ModularBuilding:'Building', Stats:'Stats' };
const SECTIONS = {
    'Identity': { icon:'üè∑Ô∏è', match: k => ['DisplayName','ContentClass','MetaData'].includes(k) },
    'AI Combat': { icon:'‚öîÔ∏è', match: k => /^Ai.*(Attack|Damage|Dmg|Block|Parr|Range|Cool|Charge|Loop|Health|Focus)/.test(k) },
    'AI Movement': { icon:'üö∂', match: k => /^Ai.*(Move|Walk|Follow|Speed|Dist)/.test(k) },
    'AI Behavior': { icon:'üß†', match: k => /^Ai.*(State|Hunt|Eat|Sleep|Mercy|Spawn|Wait|Comm|Aggro|Flee)/.test(k) },
    'AI Stats': { icon:'üìä', match: k => /^Ai.*(Level|Hp|Family|Clade|Tame|Control|Body|Hunger|Size)/.test(k) && !/Attack|Damage/.test(k) },
    'Loot': { icon:'üí∞', match: k => /^LootContent/.test(k), isLoot: true },
    'Spell': { icon:'‚ú®', match: k => /^Spell/.test(k) },
    'Gem Effect': { icon:'üíé', match: k => /^GE/.test(k) },
    'Combat': { icon:'‚öîÔ∏è', match: k => /Damage|Defence|^hp|^crit|Attack/.test(k) && !/^Ai/.test(k) },
    'Item': { icon:'üì¶', match: k => /^item|^bag|^equip|^slot|Stack|^dur|Quality/.test(k) },
    'Crafting': { icon:'üî®', match: k => /Craft|Material|Recipe/.test(k) },
    'Visual': { icon:'üé®', match: k => /Display|dynamic|color|Icon|Mesh|Texture/.test(k) },
    'Location': { icon:'üåç', match: k => /^pos|^rot|^vel|Zone|Continent|World/.test(k) },
    'Other': { icon:'üìã', match: () => true }
};

const DEFAULT_ICON = 'Items/Beeswax.png';
const DEV_PASS = 'mo2dev';
const API = 'api.php';
const PER_PAGE = 50;

let db=null, data={}, icons={}, config={}, allIcons=[], curCat=null, curPage=1, search='', devMode=false, showFavsOnly=false;
let iconOverrides={}, hiddenFields={}, favorites=new Set(), serverOK=false;
let editItem=null, selIcon=null, curModalItem=null;

// Utils
const toast = (m,t='success') => { const el=document.createElement('div'); el.className='toast'+(t==='error'?' error':t==='warning'?' warning':''); el.textContent=m; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
const esc = s => typeof s!=='string' ? String(s??'') : s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const fmt = v => { if(v===true)return'Yes'; if(v===false)return'No'; if(v==null)return'-'; if(typeof v==='object'){if(v.min!==undefined)return`${v.min} - ${v.max}`; if(v.x!==undefined)return`(${v.x}, ${v.y}, ${v.z||0})`; return JSON.stringify(v);} if(typeof v==='number')return Number.isInteger(v)?v.toLocaleString():v.toFixed(2); return String(v); };
const valClass = v => { if(typeof v==='boolean')return v?'bool':'bool false'; if(typeof v==='number')return'number'; if(typeof v==='object'&&v?.min!==undefined)return'range'; return''; };

// Parsing
function parseBlob(str) {
    if(!str) return {};
    const p = {};
    for(const line of str.split('\n')) {
        const m = line.match(/\[(\w+)\]\s*=>\s*(.*)/);
        if(!m) continue;
        const [,k,v] = m;
        if(v.includes('[UNDEFINED_FLAG]') || !v.trim()) continue;
        
        let match;
        if((match=v.match(/sData:"([^"]*)"/))) { p[k]=match[1]; continue; }
        if((match=v.match(/iData:(-?\d+)/))) { p[k]=parseInt(match[1]); continue; }
        if((match=v.match(/fData:([\d.eE+-]+)/))) { p[k]=parseFloat(match[1]); continue; }
        if(v.includes('eType:Bool')) { p[k]=v.includes('bData:true')||v.includes('bData:True'); continue; }
        if((match=v.match(/IntPair:\{iRange:\[(-?\d+),(-?\d+)\]\}/))) { p[k]={min:parseInt(match[1]),max:parseInt(match[2])}; continue; }
        if((match=v.match(/FloatPair:\{fRange:\[([\d.eE+-]+),([\d.eE+-]+)\]\}/))) { p[k]={min:parseFloat(match[1]),max:parseFloat(match[2])}; continue; }
        if((match=v.match(/Vec:\((-?[\d.]+),(-?[\d.]+),(-?[\d.]+)\)/))) { p[k]={x:parseFloat(match[1]),y:parseFloat(match[2]),z:parseFloat(match[3])}; continue; }
        if((match=v.match(/Ref:\{Name:"([^"]+)"/))) {
            p[k+'_Ref']=match[1];
            const g=v.match(/GUID:"([^"]+)"/); if(g) p[k+'_GUID']=g[1];
            if(k.startsWith('LootContent')) {
                const c=v.match(/fData:([\d.]+)/), r=v.match(/iRange:\[(\d+),(\d+)\]/);
                p[k+'_Chance']=c?parseFloat(c[1])*100:100;
                p[k+'_Min']=r?parseInt(r[1]):1;
                p[k+'_Max']=r?parseInt(r[2]):1;
            }
        }
    }
    return p;
}

function getLoot(p) {
    const items=[];
    for(let i=0;i<=9;i++) {
        const ref=p[`LootContent${i}_Ref`], chance=p[`LootContent${i}_Chance`];
        if(ref && chance>0) items.push({slot:i, item:ref, chance:Math.min(100,chance), min:p[`LootContent${i}_Min`]||1, max:p[`LootContent${i}_Max`]||1});
    }
    return items;
}

// Server config
async function loadServerConfig() {
    try {
        const r = await fetch(`${API}?action=load_all`);
        if(r.ok) {
            const j = await r.json();
            if(j.success) {
                serverOK = true;
                iconOverrides = j.data.icon_overrides || {};
                hiddenFields = j.data.hidden_fields || {};
                const favs = j.data.favorites || [];
                favorites = new Set(favs);
            }
        }
    } catch(e) { console.warn('Server unavailable'); }
}

async function saveConfig(type, cfg) {
    if(!serverOK) { toast('Server unavailable','warning'); return false; }
    try {
        const r = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'save',type,config:cfg}) });
        const j = await r.json();
        if(j.success) { toast('Saved!'); return true; }
        toast('Save failed: '+j.error,'error');
    } catch(e) { toast('Error: '+e.message,'error'); }
    return false;
}

// Icons
function getIcon(item, cat) {
    const n = item.n||'', k = `${cat}:${n}`;
    if(iconOverrides[k]) return 'Icons/'+iconOverrides[k];
    if(icons[cat]?.[n]) return 'Icons/'+icons[cat][n];
    for(const c of Object.keys(icons)) if(icons[c][n]) return 'Icons/'+icons[c][n];
    return 'Icons/'+DEFAULT_ICON;
}

// Field visibility with inheritance
function isFieldVisible(table, cls, field) {
    // Check class-level override first
    const classKey = `${table}:${cls}`;
    if(hiddenFields[classKey]?.[field] !== undefined) return !hiddenFields[classKey][field];
    // Then table-level (affects all classes)
    const tableKey = `${table}:_all`;
    if(hiddenFields[tableKey]?.[field] !== undefined) return !hiddenFields[tableKey][field];
    return true;
}

function setFieldHidden(table, cls, field, hidden) {
    const key = `${table}:${cls}`;
    if(!hiddenFields[key]) hiddenFields[key] = {};
    hiddenFields[key][field] = hidden;
}

// Load data
async function loadDB() {
    try {
        // Load configs
        const [iconRes, configRes] = await Promise.all([
            fetch('icon_mapping.json').catch(()=>null),
            fetch('table_config.json').catch(()=>null)
        ]);
        if(iconRes?.ok) {
            icons = await iconRes.json();
            const s = new Set();
            for(const c of Object.values(icons)) for(const p of Object.values(c)) s.add(p);
            allIcons = [...s].sort();
            populateFolders();
        }
        if(configRes?.ok) config = await configRes.json();
        
        await loadServerConfig();
        
        // Load database
        const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
        const dbRes = await fetch('content.db');
        if(!dbRes.ok) throw new Error('content.db not found');
        db = new SQL.Database(new Uint8Array(await dbRes.arrayBuffer()));
        
        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
        if(!tables.length) throw new Error('Empty database');
        
        data = {};
        for(const [tbl] of tables[0].values) {
            if(tbl==='version') continue;
            try {
                const res = db.exec(`SELECT * FROM "${tbl}"`);
                if(res.length && res[0].values.length) {
                    const cols = res[0].columns;
                    data[tbl] = res[0].values.map(row => {
                        const o = {}; cols.forEach((c,i) => o[c]=row[i]);
                        const str = typeof o.data==='string' ? o.data : (o.data ? new TextDecoder().decode(o.data) : '');
                        const p = parseBlob(str);
                        return {
                            n: o.name||o.guid||'Unknown',
                            d: p.DisplayName||p.SpellName||p.AiAttackName||p.GEDisplayName||o.name||'Unknown',
                            c: o.class||'unknown',
                            guid: o.guid,
                            p
                        };
                    });
                }
            } catch(e) { console.warn(`Error loading ${tbl}:`,e); }
        }
        
        document.getElementById('statusText').textContent = serverOK ? 'ONLINE' : 'LOCAL';
        document.getElementById('statusBadge').classList.toggle('error', !serverOK);
        initUI();
    } catch(e) {
        console.error(e);
        document.getElementById('statusText').textContent = 'ERROR';
        document.getElementById('statusBadge').classList.add('error');
        document.getElementById('contentArea').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Failed: ${e.message}</div></div>`;
    }
}

function populateFolders() {
    const folders = new Set();
    allIcons.forEach(p => { const s=p.split('/'); if(s.length>1) folders.add(s[0]); });
    document.getElementById('iconFolder').innerHTML = '<option value="">All</option>' + [...folders].sort().map(f=>`<option value="${f}">${f}</option>`).join('');
}

// UI Init
function initUI() {
    const cats = Object.keys(data).filter(c => data[c]?.length > 0);
    if(!cats.length) { document.getElementById('contentArea').innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">No entries</div></div>`; return; }
    
    curCat = cats[0];
    document.getElementById('navList').innerHTML = cats.map((c,i) => `<li><button class="nav-btn ${i===0?'active':''}" data-cat="${c}"><span><span class="nav-icon">${CAT_ICONS[c]||'üìÅ'}</span>${CAT_NAMES[c]||c}</span><span class="nav-count">${data[c].length}</span></button></li>`).join('');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.onclick = () => { document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); curCat=b.dataset.cat; curPage=1; render(); });
    
    let st; document.getElementById('searchInput').oninput = e => { clearTimeout(st); st=setTimeout(()=>{ search=e.target.value.toLowerCase(); curPage=1; render(); },150); };
    
    // Modal events
    const closeModal = () => { document.getElementById('modalOverlay').classList.remove('active'); document.body.style.overflow=''; curModalItem=null; };
    document.getElementById('modalOverlay').onclick = e => { if(e.target.id==='modalOverlay') closeModal(); };
    document.getElementById('modalClose').onclick = closeModal;
    document.getElementById('modalFav').onclick = () => { if(!curModalItem) return; toggleFav(curModalItem); updateModalFav(); };
    document.getElementById('modalCopy').onclick = () => { if(!curModalItem) return; navigator.clipboard.writeText(JSON.stringify(curModalItem.p,null,2)); toast('Copied!'); };
    
    // Dev mode
    document.getElementById('devBtn').onclick = toggleDev;
    document.getElementById('loginPassword').onkeypress = e => { if(e.key==='Enter') tryLogin(); };
    document.getElementById('loginBtn').onclick = tryLogin;
    document.getElementById('loginOverlay').onclick = e => { if(e.target.id==='loginOverlay') closeLogin(); };
    
    // Icon picker
    document.getElementById('iconPickerClose').onclick = closeIconPicker;
    document.getElementById('iconCancel').onclick = closeIconPicker;
    document.getElementById('iconSave').onclick = saveIcon;
    document.getElementById('iconPickerOverlay').onclick = e => { if(e.target.id==='iconPickerOverlay') closeIconPicker(); };
    document.getElementById('iconSearch').oninput = filterIcons;
    document.getElementById('iconFolder').onchange = filterIcons;
    
    // Config
    document.getElementById('configBtn').onclick = openConfig;
    document.getElementById('configClose').onclick = () => document.getElementById('configOverlay').classList.remove('active');
    document.getElementById('configOverlay').onclick = e => { if(e.target.id==='configOverlay') document.getElementById('configOverlay').classList.remove('active'); };
    document.querySelectorAll('.config-tab').forEach(t => t.onclick = () => { document.querySelectorAll('.config-tab').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.config-panel').forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.getElementById('panel-'+t.dataset.tab).classList.add('active'); });
    document.getElementById('exportIconsBtn').onclick = () => downloadJSON(iconOverrides,'icon_overrides.json');
    document.getElementById('clearIconsBtn').onclick = async () => { if(confirm('Clear all?')) { iconOverrides={}; await saveConfig('icon_overrides',iconOverrides); render(); renderOverrides(); }};
    document.getElementById('fieldTable').onchange = populateClasses;
    document.getElementById('fieldClass').onchange = populateFields;
    document.getElementById('saveFieldsBtn').onclick = async () => { await saveConfig('hidden_fields',hiddenFields); };
    document.getElementById('exportFieldsBtn').onclick = () => downloadJSON(hiddenFields,'hidden_fields.json');
    document.getElementById('exportAllBtn').onclick = () => downloadJSON({iconOverrides,hiddenFields,favorites:[...favorites]},'mo2_config.json');
    
    // Favorites
    document.getElementById('favBtn').onclick = () => { showFavsOnly=!showFavsOnly; document.getElementById('favBtn').classList.toggle('active',showFavsOnly); curPage=1; render(); };
    
    // Keyboard
    document.onkeydown = e => {
        if(e.key==='Escape') { closeModal(); closeLogin(); closeIconPicker(); document.getElementById('configOverlay').classList.remove('active'); }
        if((e.ctrlKey||e.metaKey) && e.key==='k') { e.preventDefault(); document.getElementById('searchInput').focus(); }
    };
    
    render();
}

function downloadJSON(d,f) { const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}), u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download=f; a.click(); URL.revokeObjectURL(u); }

// Dev mode
function toggleDev() {
    if(devMode) { devMode=false; document.body.classList.remove('dev-mode'); document.getElementById('devBtn').classList.remove('active'); document.getElementById('configBtn').style.display='none'; document.getElementById('statusBadge').classList.remove('dev'); render(); }
    else { document.getElementById('loginOverlay').classList.add('active'); document.getElementById('loginPassword').focus(); }
}
function tryLogin() {
    if(document.getElementById('loginPassword').value===DEV_PASS) { devMode=true; document.body.classList.add('dev-mode'); document.getElementById('devBtn').classList.add('active'); document.getElementById('configBtn').style.display=''; document.getElementById('statusBadge').classList.add('dev'); closeLogin(); render(); toast('Dev mode on!'); }
    else { document.getElementById('loginPassword').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('loginPassword').style.borderColor='',500); }
}
function closeLogin() { document.getElementById('loginOverlay').classList.remove('active'); document.getElementById('loginPassword').value=''; }

// Favorites
function toggleFav(item) {
    const key = `${curCat}:${item.n}`;
    if(favorites.has(key)) favorites.delete(key); else favorites.add(key);
    saveConfig('favorites',[...favorites]);
}
function isFav(item) { return favorites.has(`${curCat}:${item.n}`); }
function updateModalFav() { document.getElementById('modalFav').classList.toggle('active',curModalItem&&isFav(curModalItem)); }

// Icon picker
function openIconPicker(item, e) {
    e.stopPropagation();
    editItem = item;
    selIcon = null;
    const cur = getIcon(item,curCat).replace('Icons/','');
    document.getElementById('iconPickerItem').textContent = item.d||item.n;
    document.getElementById('curIconImg').src = 'Icons/'+cur;
    document.getElementById('curIconPath').textContent = cur;
    document.getElementById('iconSearch').value = '';
    document.getElementById('iconFolder').value = '';
    renderIconGrid();
    document.getElementById('iconPickerOverlay').classList.add('active');
}
function renderIconGrid(filter='',folder='') {
    let list = allIcons;
    if(folder) list = list.filter(p=>p.startsWith(folder+'/'));
    if(filter) list = list.filter(p=>p.toLowerCase().includes(filter.toLowerCase()));
    list = list.slice(0,150);
    const g = document.getElementById('iconGrid');
    g.innerHTML = list.map(p=>`<div class="icon-opt ${selIcon===p?'selected':''}" data-p="${p}" title="${p}"><img src="Icons/${p}" onerror="this.src='Icons/${DEFAULT_ICON}'"></div>`).join('');
    g.querySelectorAll('.icon-opt').forEach(o => o.onclick = () => { g.querySelectorAll('.icon-opt').forEach(x=>x.classList.remove('selected')); o.classList.add('selected'); selIcon=o.dataset.p; });
}
function filterIcons() { renderIconGrid(document.getElementById('iconSearch').value, document.getElementById('iconFolder').value); }
async function saveIcon() {
    if(!editItem||!selIcon) { closeIconPicker(); return; }
    iconOverrides[`${curCat}:${editItem.n}`] = selIcon;
    await saveConfig('icon_overrides',iconOverrides);
    closeIconPicker();
    render();
}
function closeIconPicker() { document.getElementById('iconPickerOverlay').classList.remove('active'); editItem=null; selIcon=null; }

// Config
function openConfig() {
    document.getElementById('configOverlay').classList.add('active');
    renderOverrides();
    populateTables();
    renderDbInfo();
}
function renderOverrides() {
    const el = document.getElementById('iconOverridesList');
    const e = Object.entries(iconOverrides);
    if(!e.length) { el.innerHTML='<div style="color:var(--text-dim);padding:0.75rem;text-align:center">No overrides</div>'; return; }
    el.innerHTML = e.map(([k,p])=>{ const [cat,name]=k.split(':'); return `<div class="override-item"><img src="Icons/${p}" onerror="this.src='Icons/${DEFAULT_ICON}'"><div class="override-info"><div class="override-name">${esc(name)}</div><div class="override-path">${esc(cat)} ‚Üí ${esc(p)}</div></div><button class="override-remove" data-k="${esc(k)}">‚úï</button></div>`; }).join('');
    el.querySelectorAll('.override-remove').forEach(b => b.onclick = async () => { delete iconOverrides[b.dataset.k]; await saveConfig('icon_overrides',iconOverrides); renderOverrides(); render(); });
}
function populateTables() {
    const s = document.getElementById('fieldTable');
    const tbls = Object.keys(data).filter(t=>data[t]?.length>0);
    s.innerHTML = '<option value="">Select table...</option>' + tbls.map(t=>`<option value="${t}">${CAT_NAMES[t]||t}</option>`).join('');
}
function populateClasses() {
    const tbl = document.getElementById('fieldTable').value;
    const cs = document.getElementById('fieldClass');
    if(!tbl||!data[tbl]) { cs.innerHTML='<option value="_all">All Classes</option>'; document.getElementById('fieldsList').innerHTML=''; return; }
    const classes = [...new Set(data[tbl].map(i=>i.c))].sort();
    cs.innerHTML = '<option value="_all">‚öôÔ∏è All Classes (Global)</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    populateFields();
}
function populateFields() {
    const tbl = document.getElementById('fieldTable').value;
    const cls = document.getElementById('fieldClass').value;
    const el = document.getElementById('fieldsList');
    if(!tbl||!data[tbl]) { el.innerHTML=''; return; }
    
    // Collect fields
    let items = data[tbl];
    if(cls!=='_all') items = items.filter(i=>i.c===cls);
    const fields = new Set();
    items.forEach(i => Object.keys(i.p||{}).forEach(k => { if(!k.endsWith('_GUID')&&!k.endsWith('_Chance')&&!k.endsWith('_Min')&&!k.endsWith('_Max')) fields.add(k); }));
    
    const sorted = [...fields].sort();
    const key = `${tbl}:${cls}`;
    const globalKey = `${tbl}:_all`;
    
    el.innerHTML = sorted.map(f => {
        const globalHidden = hiddenFields[globalKey]?.[f];
        const classHidden = hiddenFields[key]?.[f];
        const isHidden = cls==='_all' ? globalHidden : (classHidden!==undefined ? classHidden : globalHidden);
        const hasOverride = cls!=='_all' && classHidden!==undefined && globalHidden!==undefined && classHidden!==globalHidden;
        return `<div class="field-item ${isHidden?'hidden':''}"><input type="checkbox" data-f="${f}" ${!isHidden?'checked':''}><label>${f}</label>${hasOverride?'<span class="override-badge">override</span>':''}</div>`;
    }).join('');
    
    el.querySelectorAll('input').forEach(inp => {
        inp.onchange = () => {
            const field = inp.dataset.f;
            setFieldHidden(tbl, cls, field, !inp.checked);
            populateFields(); // Refresh to show override badges
        };
    });
}
function renderDbInfo() {
    const el = document.getElementById('dbInfo');
    let html = '<div style="margin-bottom:0.5rem"><b>Tables:</b></div>';
    for(const [t,items] of Object.entries(data)) {
        if(!items?.length) continue;
        const classes = [...new Set(items.map(i=>i.c))];
        html += `<div style="margin-left:0.5rem;margin-bottom:0.25rem">${CAT_ICONS[t]||'üìÅ'} <b>${CAT_NAMES[t]||t}</b>: ${items.length} entries (${classes.length} classes)</div>`;
    }
    html += `<div style="margin-top:0.75rem"><b>Server:</b> ${serverOK?'Connected':'Unavailable'}</div>`;
    html += `<div><b>Config version:</b> ${config._meta?.version||'N/A'}</div>`;
    el.innerHTML = html;
}

// Render content
function filter(items) {
    let list = items;
    if(showFavsOnly) list = list.filter(i => isFav(i));
    if(!search) return list;
    return list.filter(i => [i.n,i.d,i.c].some(s=>(s||'').toLowerCase().includes(search)));
}

function render() {
    const items = data[curCat] || [];
    const filtered = filter(items);
    const totalPages = Math.ceil(filtered.length / PER_PAGE);
    const start = (curPage-1) * PER_PAGE;
    const pageItems = filtered.slice(start, start+PER_PAGE);
    const ca = document.getElementById('contentArea');
    
    if(!filtered.length) {
        ca.innerHTML = `<div class="content-header"><h2 class="content-title"><span class="content-title-icon">${CAT_ICONS[curCat]||'üìÅ'}</span>${CAT_NAMES[curCat]||curCat}</h2></div><div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">${search?'No results for "'+esc(search)+'"':showFavsOnly?'No favorites':'No entries'}</div></div>`;
        return;
    }
    
    // Get key fields from config
    const ti = config.other_tables?.[curCat];
    const keyFields = Object.keys(ti?.key_fields||{}).filter(k=>k!=='DisplayName'&&ti.key_fields[k].visible!==false);
    
    let html = `<div class="content-header"><h2 class="content-title"><span class="content-title-icon">${CAT_ICONS[curCat]||'üìÅ'}</span>${CAT_NAMES[curCat]||curCat}</h2><div class="content-stats"><div class="results-count"><span>${start+1}-${Math.min(start+PER_PAGE,filtered.length)}</span> of <span>${filtered.length}</span></div></div></div><div class="items-grid">`;
    
    pageItems.forEach((item,idx) => {
        const dn=item.d||item.n||'Unknown', n=item.n||'', cls=item.c||'', props=item.p||{}, icon=getIcon(item,curCat), hasOvr=iconOverrides[`${curCat}:${item.n}`], fav=isFav(item);
        // Preview props - use key fields or auto-select
        const pk = keyFields.length ? keyFields.filter(k=>props[k]!==undefined).slice(0,3) : Object.keys(props).filter(k=>!k.includes('_')&&k!=='DisplayName'&&k!=='ContentClass'&&isFieldVisible(curCat,cls,k)).slice(0,3);
        html += `<div class="item-card ${fav?'favorite':''}" data-idx="${start+idx}"><div class="item-header"><div class="item-icon" style="${hasOvr?'border-color:var(--neon-green)':''}"><img src="${icon}" onerror="this.src='Icons/${DEFAULT_ICON}'"><button class="edit-icon-btn" data-i="${start+idx}">‚úèÔ∏è</button></div><div class="item-info"><div class="item-name">${esc(dn)}</div><span class="item-class">${esc(cls)}</span><div class="item-internal">${esc(n)}</div></div></div><div class="item-props">${pk.map(k=>`<span class="item-prop"><span class="item-prop-key">${k}:</span> <span class="item-prop-val">${fmt(props[k])}</span></span>`).join('')}</div></div>`;
    });
    html += '</div>';
    
    if(totalPages>1) {
        html += `<div class="pagination"><button class="page-btn" ${curPage===1?'disabled':''} onclick="goPage(${curPage-1})">‚Üê</button>`;
        const max=7; let sp=Math.max(1,curPage-3), ep=Math.min(totalPages,sp+max-1);
        if(ep-sp<max-1) sp=Math.max(1,ep-max+1);
        if(sp>1) { html+=`<button class="page-btn" onclick="goPage(1)">1</button>`; if(sp>2)html+=`<span class="page-info">‚Ä¶</span>`; }
        for(let i=sp;i<=ep;i++) html+=`<button class="page-btn ${i===curPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
        if(ep<totalPages) { if(ep<totalPages-1)html+=`<span class="page-info">‚Ä¶</span>`; html+=`<button class="page-btn" onclick="goPage(${totalPages})">${totalPages}</button>`; }
        html += `<button class="page-btn" ${curPage===totalPages?'disabled':''} onclick="goPage(${curPage+1})">‚Üí</button></div>`;
    }
    
    ca.innerHTML = html;
    document.querySelectorAll('.item-card').forEach(c => c.onclick = e => { if(e.target.closest('.edit-icon-btn'))return; openModal(filtered[+c.dataset.idx]); });
    document.querySelectorAll('.edit-icon-btn').forEach(b => b.onclick = e => openIconPicker(filtered[+b.dataset.i],e));
}

window.goPage = p => { curPage=p; render(); window.scrollTo({top:0,behavior:'smooth'}); };

// Modal
function openModal(item) {
    curModalItem = item;
    const dn=item.d||item.n||'Unknown', cls=item.c||'', props=item.p||{}, icon=getIcon(item,curCat);
    
    document.getElementById('modalTitle').textContent = dn;
    document.getElementById('modalClass').textContent = cls;
    document.getElementById('modalIcon').innerHTML = `<img src="${icon}" onerror="this.src='Icons/${DEFAULT_ICON}'">`;
    updateModalFav();
    
    // Organize properties into sections
    const sections = {};
    const loot = getLoot(props);
    const assigned = new Set();
    
    for(const [name,cfg] of Object.entries(SECTIONS)) {
        if(cfg.isLoot) { if(loot.length) sections[name]={icon:cfg.icon,loot}; continue; }
        sections[name] = {icon:cfg.icon, props:[]};
    }
    
    // Visible props only (based on field visibility settings)
    const visibleProps = Object.entries(props).filter(([k]) => {
        if(k.endsWith('_GUID')||k.endsWith('_Chance')||k.endsWith('_Min')||k.endsWith('_Max')) return false;
        if(k.startsWith('LootContent')) return false;
        return isFieldVisible(curCat, cls, k);
    });
    
    for(const [k,v] of visibleProps) {
        for(const [name,cfg] of Object.entries(SECTIONS)) {
            if(cfg.isLoot) continue;
            if(cfg.match(k) && !assigned.has(k)) {
                sections[name].props.push([k,v]);
                assigned.add(k);
                break;
            }
        }
    }
    
    let html = '';
    
    // Identity section
    if(item.n && item.n !== dn) {
        html += `<div class="section"><div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')"><div class="section-title"><span class="section-icon">üè∑Ô∏è</span>Identity</div><span class="section-toggle">‚ñº</span></div><div class="section-content"><div class="prop"><div class="prop-key">Internal Name</div><div class="prop-value">${esc(item.n)}</div></div>${item.guid?`<div class="prop"><div class="prop-key">GUID</div><div class="prop-value" style="font-size:0.65rem">${esc(item.guid)}</div></div>`:''}</div></div>`;
    }
    
    for(const [name,sec] of Object.entries(sections)) {
        if(sec.loot?.length) {
            html += `<div class="section"><div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')"><div class="section-title"><span class="section-icon">${sec.icon}</span>${name}</div><div class="section-meta"><span class="section-count">${sec.loot.length}</span><span class="section-toggle">‚ñº</span></div></div><div class="section-content" style="display:block"><table class="loot-table"><thead><tr><th>#</th><th>Item</th><th>Chance</th><th>Qty</th></tr></thead><tbody>${sec.loot.map(l=>`<tr><td>${l.slot}</td><td><span class="loot-link" onclick="searchItem('${esc(l.item)}')">${esc(l.item)}</span></td><td class="loot-chance">${l.chance.toFixed(0)}%</td><td class="loot-qty">${l.min===l.max?l.min:`${l.min}-${l.max}`}</td></tr>`).join('')}</tbody></table></div></div>`;
        } else if(sec.props?.length) {
            html += `<div class="section"><div class="section-header" onclick="this.parentElement.classList.toggle('collapsed')"><div class="section-title"><span class="section-icon">${sec.icon}</span>${name}</div><div class="section-meta"><span class="section-count">${sec.props.length}</span><span class="section-toggle">‚ñº</span></div></div><div class="section-content">${sec.props.map(([k,v])=>{
                const vc = valClass(v);
                const isRef = k.endsWith('_Ref');
                return `<div class="prop"><div class="prop-key">${esc(k)}</div><div class="prop-value ${vc} ${isRef?'ref':''}" ${isRef?`onclick="searchItem('${esc(v)}')"`:''}>${esc(fmt(v))}</div></div>`;
            }).join('')}</div></div>`;
        }
    }
    
    if(!html) html = `<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">No properties</div></div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

window.searchItem = name => {
    document.getElementById('modalOverlay').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('searchInput').value = name;
    search = name.toLowerCase();
    curPage = 1;
    // Find category
    for(const [c,items] of Object.entries(data)) {
        if(items.some(i => i.n===name || i.d===name)) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active',b.dataset.cat===c));
            curCat = c;
            break;
        }
    }
    render();
};

loadDB();
</script>
</body>
</html>